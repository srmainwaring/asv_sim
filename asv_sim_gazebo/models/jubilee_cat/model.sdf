<?xml version="1.0" ?>
<!--
  Copyright (C) 2023  Rhys Mainwaring

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<sdf version="1.6">
  <model name="jubilee_cat">
    <link name="base_link">
      <pose>0 0 0 0 0 0</pose>
      <inertial>
        <pose>0 0 0.03 0 0 0</pose>
        <mass>4</mass>
        <inertia>
          <ixx>0.091241667</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.233321667</iyy>
          <iyz>0</iyz>
          <izz>0.312770667</izz>
        </inertia>
      </inertial>
      <collision name="left_hull_collision">
        <pose>0 0.2 0 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://jubilee_cat/meshes/jubilee_cat_hull_collision.stl</uri>
          </mesh>
          <!-- box for inertial approx -->
          <!-- <box>
            <size>0.826 0.506 0.133</size>
          </box> -->
        </geometry>
      </collision>
      <collision name="right_hull_collision">
        <pose>0 -0.2 0 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://jubilee_cat/meshes/jubilee_cat_hull_collision.stl</uri>
          </mesh>
        </geometry>
      </collision>
      <visual name="base_link_visual">
        <pose>0 0 0 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://jubilee_cat/meshes/jubilee_cat_base.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <sensor name="imu_sensor" type="imu">
        <pose>0 0 0 3.141593 0 0</pose>
        <always_on>1</always_on>
        <update_rate>1000</update_rate>
      </sensor>

      <!-- todo place on separate link -->
        <sensor name="magnetometer_sensor" type="magnetometer">
          <always_on>1</always_on>
          <update_rate>30</update_rate>
        </sensor>

      <!-- todo place on separate link -->
      <sensor name="navsat_sensor" type="navsat">
        <always_on>1</always_on>
        <update_rate>30</update_rate>
      </sensor>

      <!-- todo place on separate link -->
      <sensor name="anemometer_sensor" type="custom" gz:type="anemometer">
        <always_on>1</always_on>
        <update_rate>30</update_rate>
      </sensor>

      <!-- todo place on separate link -->
      <sensor name="camera" type="camera">
        <pose>0.2 0 0.15 0 0 0</pose>
        <always_on>1</always_on>
        <update_rate>30</update_rate>
        <camera>
          <horizontal_fov>1.047</horizontal_fov>
          <image>
            <width>320</width>
            <height>240</height>
          </image>
          <clip>
            <near>0.1</near>
            <far>100</far>
          </clip>
        </camera>
      </sensor>

    </link>

    <!-- left motor cw -->
    <link name="left_motor_link">
      <pose relative_to="left_motor_joint">0 0 0 0 0 0</pose>
      <inertial>
        <mass>0.1</mass>
        <inertia>
          <ixx>3.39213E-05</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>3.39213E-05</iyy>
          <iyz>0</iyz>
          <izz>0.0000512</izz>
        </inertia>
      </inertial>
      <collision name="collision">
        <geometry>
          <cylinder>
            <radius>0.032</radius>
            <length>0.0316</length>
          </cylinder>
        </geometry>
      </collision>
      <visual name="visual">
        <geometry>
          <mesh>
            <uri>model://jubilee_cat/meshes/jubilee_cat_cw_prop.dae</uri>
          </mesh>
        </geometry>
      </visual>
    </link>
    <joint name="left_motor_joint" type="revolute">
      <pose relative_to="base_link">-0.085013 0.2086 -0.16793 0 1.5708 0</pose>
      <child>left_motor_link</child>
      <parent>base_link</parent>
      <axis>
        <xyz>0 0 1</xyz>
        <limit>
          <lower>-1.0E+8</lower>
          <upper>1.0E+8</upper>
        </limit>
        <dynamics>
          <damping>0.001</damping>
        </dynamics>
      </axis>
    </joint>

    <!-- right motor ccw -->
    <link name="right_motor_link">
      <pose relative_to="right_motor_joint">0 0 0 0 0 0</pose>
      <inertial>
        <mass>0.1</mass>
        <inertia>
          <ixx>3.39213E-05</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>3.39213E-05</iyy>
          <iyz>0</iyz>
          <izz>0.0000512</izz>
        </inertia>
      </inertial>
      <collision name="collision">
        <geometry>
          <cylinder>
            <radius>0.032</radius>
            <length>0.0316</length>
          </cylinder>
        </geometry>
      </collision>
      <visual name="visual">
        <geometry>
          <mesh>
            <uri>model://jubilee_cat/meshes/jubilee_cat_ccw_prop.dae</uri>
          </mesh>
        </geometry>
      </visual>
    </link>
    <joint name="right_motor_joint" type="revolute">
      <pose relative_to="base_link">-0.085013 -0.2086 -0.16793 0 1.5708 0</pose>
      <child>right_motor_link</child>
      <parent>base_link</parent>
      <axis>
        <xyz>0 0 1</xyz>
        <limit>
          <lower>-1.0E+8</lower>
          <upper>1.0E+8</upper>
        </limit>
        <dynamics>
          <damping>0.001</damping>
        </dynamics>
      </axis>
    </joint>

    <!-- @online{GazeboFuel-nate-Electrical-Box,
      title={Electrical Box},
      organization={Open Robotics},
      date={2018},
      month={September},
      day={3},
      author={nate},
      url={https://fuel.gazebosim.org/1.0/nate/models/Electrical Box},
    } -->
    <!-- <include>
      <pose>0 0 0.2 0 0 0</pose>
      <uri>https://fuel.gazebosim.org/1.0/nate/models/Electrical Box</uri>
      <name>electrical_box</name>
    </include> -->
    <link name="electrical_box_link">
      <pose>0 0 0.165 0 0 0</pose>
      <inertial>
        <mass>0.5</mass>
        <inertia>
          <ixx>0.002804167</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.001804167</iyy>
          <iyz>0</iyz>
          <izz>0.003408333</izz>
        </inertia>
      </inertial>
      <collision name="collision">
        <geometry>
          <box>
            <size>0.17 0.23 0.12</size>
          </box>
        </geometry>
      </collision>
      <visual name="visual">
        <pose>0 0 -0.055 1.57 3.14159 0</pose>
        <geometry>
          <mesh>
            <uri>model://jubilee_cat/meshes/electrical_box.dae</uri>
            <scale>0.4 0.4 0.4</scale>
          </mesh>
        </geometry>
      </visual>
    </link>
    <joint name="electrical_box_joint" type="revolute">
      <child>electrical_box_link</child>
      <parent>base_link</parent>
      <axis>
        <xyz>0 0 1</xyz>
        <limit>
          <lower>0</lower>
          <upper>0</upper>
        </limit>
        <dynamics>
          <damping>1.</damping>
        </dynamics>
      </axis>
    </joint>

    <!-- Plugins -->
    <plugin
      name="gz::sim::systems::JointStatePublisher"
      filename="gz-sim-joint-state-publisher-system">
    </plugin>

    <!-- left motor thruster cw -->
    <plugin
      name="gz::sim::systems::Thruster"
      filename="gz-sim-thruster-system">
      <namespace>jubilee_cat</namespace>
      <joint_name>left_motor_joint</joint_name>
      <thrust_coefficient>0.02</thrust_coefficient>
      <fluid_density>1025</fluid_density>
      <propeller_diameter>0.064</propeller_diameter>
      <velocity_control>0</velocity_control>
      <use_angvel_cmd>0</use_angvel_cmd>
    </plugin>

    <!-- right motor thruster ccw -->
    <plugin
      name="gz::sim::systems::Thruster"
      filename="gz-sim-thruster-system">
      <namespace>jubilee_cat</namespace>
      <joint_name>right_motor_joint</joint_name>
      <thrust_coefficient>-0.02</thrust_coefficient>
      <fluid_density>1025</fluid_density>
      <propeller_diameter>0.064</propeller_diameter>
      <velocity_control>0</velocity_control>
      <use_angvel_cmd>0</use_angvel_cmd>
    </plugin>

    <plugin
      name="gz::sim::systems::Hydrodynamics"
      filename="gz-waves1-hydrodynamics-system">

      <!-- Not working correctly for nested models? -->
      <enable>jubilee_cat::base_link::left_hull_collision</enable>
      <enable>jubilee_cat::base_link::right_hull_collision</enable>

      <hydrodynamics>
        <damping_on>1</damping_on>
        <viscous_drag_on>1</viscous_drag_on>
        <pressure_drag_on>1</pressure_drag_on>
      </hydrodynamics>
      <markers>
        <update_rate>10</update_rate>
        <water_patch>0</water_patch>
        <waterline>0</waterline>
        <underwater_surface>0</underwater_surface>
      </markers>
    </plugin>
  
    <!-- ArduPilot plugin -->
    <plugin
      name="ArduPilotPlugin"
      filename="ArduPilotPlugin">
      <fdm_addr>127.0.0.1</fdm_addr>
      <fdm_port_in>9002</fdm_port_in>        
      <connectionTimeoutMaxCount>5</connectionTimeoutMaxCount>
      <lock_step>1</lock_step>
      <gazeboXYZToNED>0 0 0 3.141593 0 1.57079632</gazeboXYZToNED>
      <modelXYZToAirplaneXForwardZDown>0 0 0 3.141593 0 0</modelXYZToAirplaneXForwardZDown>
      <imuName>base_link::imu_sensor</imuName>

      <!--
        left motor cw

        SERVO1_FUNCTION 73 (ThrottleLeft)
        SERVO1_MAX 2000
        SERVO1_MIN 1000
      -->
      <control channel="0">
        <jointName>left_motor_joint</jointName>
        <multiplier>10</multiplier>
        <offset>-0.5</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>COMMAND</type>
        <cmd_topic>/model/jubilee_cat/joint/left_motor_joint/cmd_thrust</cmd_topic>
      </control>

      <!--
        right motor ccw

        SERVO3_FUNCTION 74 (ThrottleRight)
        SERVO3_MAX 2000
        SERVO3_MIN 1000
      -->
      <control channel="2">
        <jointName>right_motor_joint</jointName>
        <multiplier>10</multiplier>
        <offset>-0.5</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>COMMAND</type>
        <cmd_topic>/model/jubilee_cat/joint/right_motor_joint/cmd_thrust</cmd_topic>
      </control>
    </plugin>

  </model>
</sdf>
